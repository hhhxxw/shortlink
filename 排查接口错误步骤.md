# 🔧 接口错误排查步骤

## 错误信息
```json
{
    "code": "B000001",
    "message": "系统执行出错",
    "data": null,
    "requestId": null,
    "success": false
}
```

**错误码 B000001**: 这是一个通用的系统异常，表示后端执行时出现了未捕获的异常。

---

## 📋 排查步骤（按优先级）

### ✅ 第1步：检查 project 服务是否启动

**原因**: admin(8902) 需要调用 project(8001)，如果project没启动会报错。

#### 检查方法：

```bash
# 方法1：检查端口是否被占用
netstat -ano | findstr "8001"

# 方法2：直接访问project服务
curl http://127.0.0.1:8001/api/short-link/v1/page?gid=15&current=1&size=10
```

#### 在浏览器访问：
```
http://127.0.0.1:8001/api/short-link/v1/page?gid=15&current=1&size=10
```

**如果无法访问，说明project服务没启动！**

#### 解决方法：
```bash
# 启动 project 服务
cd project
mvn spring-boot:run

# 或在IDEA中运行 ShortLinkApplication
```

---

### ✅ 第2步：查看 admin 服务的日志

**原因**: 日志会显示具体的错误信息，比如连接超时、空指针等。

#### 查看方法：

**在IDEA控制台查看**，找到类似这样的错误：
```
ERROR c.n.s.a.r.d.ShortLinkRemoteServiceImpl - 远程调用分页查询短链接失败
java.net.ConnectException: Connection refused: connect
```

或者：
```
ERROR c.n.s.a.c.w.GlobalExceptionHandler - 系统执行出错
java.lang.NullPointerException: ...
```

#### 常见错误信息对照：

| 日志错误 | 原因 | 解决方法 |
|---------|------|---------|
| `Connection refused` | project服务未启动 | 启动project服务 |
| `Read timed out` | project响应超时 | 检查project服务状态 |
| `NullPointerException` | 数据为空或配置错误 | 检查数据库和配置 |
| `Unknown host` | 配置的URL错误 | 检查application.yaml |

---

### ✅ 第3步：检查配置文件

**原因**: 可能配置的project服务地址不正确。

#### 检查 admin/src/main/resources/application.yaml

```yaml
# 确认这个配置存在且正确
short-link:
  project:
    url: http://127.0.0.1:8001  # ✅ 确认端口号
```

**常见错误：**
- ❌ 端口号写错（如8002、8000）
- ❌ IP地址错误
- ❌ 缺少http://前缀

---

### ✅ 第4步：检查数据库中是否有数据

**原因**: 查询的gid可能不存在。

#### 在数据库执行：

```sql
-- 检查分组是否存在
SELECT * FROM t_group WHERE gid = '15';

-- 检查该分组下是否有短链接
SELECT * FROM t_link WHERE gid = '15';
```

**如果没有数据：**
- 先创建一个分组（gid='15'）
- 或者使用已存在的gid进行查询

---

### ✅ 第5步：测试 project 服务的接口

**原因**: 确认project服务本身是否正常工作。

#### 使用Postman直接测试project服务：

**请求：**
```
GET http://127.0.0.1:8001/api/short-link/v1/page?gid=15&current=1&size=10
```

**如果project直接访问也报错，说明问题在project服务本身。**

**如果project访问正常，说明问题在admin的远程调用逻辑。**

---

### ✅ 第6步：检查数据库连接

**原因**: MySQL可能没启动或连接配置错误。

#### 检查MySQL状态：

```bash
# Windows
net start mysql

# 或在任务管理器查看 mysqld.exe 进程
```

#### 检查连接配置（admin和project都要检查）：

```yaml
spring:
  datasource:
    driver-class-name: org.apache.shardingsphere.driver.ShardingSphereDriver
    url: jdbc:shardingsphere:classpath:shardingsphere-config.yaml
```

---

### ✅ 第7步：检查Redis连接

**原因**: Redis可能没启动。

#### 检查Redis状态：

```bash
# 连接Redis
redis-cli

# 测试
ping
# 应该返回 PONG
```

---

## 🎯 快速诊断流程图

```
请求 admin:8902 接口
    ↓
返回"系统执行出错"
    ↓
┌─────────────────────────────────┐
│ 1. project(8001)启动了吗？      │
│    NO → 启动project服务         │
│    YES → 继续                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 2. 直接访问project接口正常吗？  │
│    NO → 排查project服务         │
│    YES → 继续                   │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│ 3. 查看admin日志的具体错误      │
│    → 根据错误信息解决           │
└─────────────────────────────────┘
```

---

## 🔧 完整的启动顺序

### 正确的启动步骤：

```bash
# 1. 启动 MySQL
net start mysql

# 2. 启动 Redis
redis-server

# 3. 启动 project 服务（先启动！）
cd project
mvn spring-boot:run
# 等待启动完成，看到 "Started ShortLinkApplication..."

# 4. 启动 admin 服务
cd admin
mvn spring-boot:run
# 等待启动完成

# 5. 测试接口
# Postman: GET http://127.0.0.1:8902/api/short-link/admin/v1/page?gid=15&current=1&size=10
```

---

## 🐛 常见错误场景

### 场景1: project服务未启动
```
错误: Connection refused
解决: 启动project服务
```

### 场景2: 数据库连接失败
```
错误: Communications link failure
解决: 
1. 启动MySQL
2. 检查数据库配置
3. 检查数据库是否存在
```

### 场景3: gid不存在
```
错误: 返回空数据或异常
解决: 
1. 检查数据库中是否有该gid的分组
2. 使用正确的gid进行查询
```

### 场景4: 端口被占用
```
错误: Port 8001 already in use
解决:
1. 关闭占用端口的程序
2. 或修改端口号
```

---

## 📝 验证清单

在测试接口前，确认以下所有项：

- [ ] MySQL 已启动
- [ ] Redis 已启动
- [ ] project 服务已启动（8001端口）
- [ ] admin 服务已启动（8902端口）
- [ ] 数据库中存在测试数据（gid='15'的分组）
- [ ] application.yaml 配置正确
- [ ] 能直接访问 project 接口（http://127.0.0.1:8001/...）

---

## 💡 如何查看详细错误信息

### 方法1: 在IDEA控制台查看
- 运行admin服务时，控制台会输出错误日志
- 找到 `ERROR` 级别的日志

### 方法2: 断点调试
在这些位置打断点：
```java
// admin/remote/dto/ShortLinkRemoteServiceImpl.java
@Override
public Result<IPage<ShortLinkPageRespDTO>> pageShortLink(...) {
    // 在这里打断点
    try {
        String response = restTemplate.getForObject(...);
        // 查看response的值
    } catch (Exception e) {
        // 在这里打断点，查看异常信息
        log.error("远程调用分页查询短链接失败", e);
    }
}
```

---

## 🎯 最可能的原因（优先检查）

根据经验，90%的概率是以下原因之一：

1. **project服务没启动** ⭐⭐⭐⭐⭐（最常见）
2. **MySQL没启动** ⭐⭐⭐⭐
3. **gid不存在** ⭐⭐⭐
4. **Redis没启动** ⭐⭐

**建议先检查第1和第2项！** 