# 401 Unauthorized é”™è¯¯ä¿®å¤æŒ‡å—

## ğŸ”´ é—®é¢˜è¯Šæ–­

### é”™è¯¯ä¿¡æ¯
```
org.springframework.web.client.HttpClientErrorException$Unauthorized: 401 : [no body]
```

### æ ¹æœ¬åŸå› 

**adminæœåŠ¡è°ƒç”¨projectæœåŠ¡æ—¶ï¼Œç¼ºå°‘ç”¨æˆ·è®¤è¯ä¿¡æ¯ä¼ é€’**

1. **adminæœåŠ¡**: æœ‰UserTransmitFilterï¼Œä»HTTP Headerä¸­è·å–usernameå’Œtoken
2. **projectæœåŠ¡**: å¯ç”¨äº†Spring Securityï¼Œä½†æ²¡æœ‰æ¥æ”¶ç”¨æˆ·ä¿¡æ¯çš„æœºåˆ¶
3. **è¿œç¨‹è°ƒç”¨**: admin â†’ projectæ—¶ï¼ŒRestTemplateæ²¡æœ‰ä¼ é€’username
4. **ç»“æœ**: projectæœåŠ¡çš„Spring Securityæ‹¦æˆªè¯·æ±‚ï¼Œè¿”å›401é”™è¯¯

## âœ… ä¿®å¤æ–¹æ¡ˆ

### å·²å®Œæˆçš„ä»£ç ä¿®æ”¹

#### ä¿®æ”¹1ï¼šadminæœåŠ¡ - ä¼ é€’ç”¨æˆ·ä¿¡æ¯

**æ–‡ä»¶**: `admin/src/main/java/com/nageoffer/shorlink/admin/remote/ShortLinkRemoteServiceImpl.java`

```java
// æ·»åŠ å¯¼å…¥
import com.nageoffer.shorlink.admin.common.biz.user.UserContext;

// åœ¨updateShortLinkæ–¹æ³•ä¸­æ·»åŠ 
HttpHeaders headers = new HttpHeaders();
headers.setContentType(MediaType.APPLICATION_JSON);

// ä¼ é€’ç”¨æˆ·ä¿¡æ¯åˆ°projectæœåŠ¡ï¼ˆå…³é”®ä¿®å¤ï¼ï¼‰
String username = UserContext.getUsername();
if (username != null) {
    headers.set("username", username);
    log.info("ä¼ é€’ç”¨æˆ·ä¿¡æ¯ - username: {}", username);
}
```

#### ä¿®æ”¹2ï¼šprojectæœåŠ¡ - æ¥æ”¶ç”¨æˆ·ä¿¡æ¯

**æ–°å¢æ–‡ä»¶**:
1. `project/src/main/java/com/nageoffer/shorlink/project/common/biz/user/UserContext.java`
2. `project/src/main/java/com/nageoffer/shorlink/project/common/biz/user/UserTransmitFilter.java`
3. `project/src/main/java/com/nageoffer/shorlink/project/config/UserConfiguration.java`

**åŠŸèƒ½**: ä»HTTP Headerä¸­æå–usernameï¼Œå­˜å…¥ThreadLocal

#### ä¿®æ”¹3ï¼šprojectæœåŠ¡ - å…³é—­Spring Securityè®¤è¯

**æ–°å¢æ–‡ä»¶**: `project/src/main/java/com/nageoffer/shorlink/project/config/SecurityConfiguration.java`

```java
@Configuration
@EnableWebSecurity
public class SecurityConfiguration {
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(auth -> auth
                .anyRequest().permitAll()  // å…è®¸æ‰€æœ‰è¯·æ±‚
            );
        return http.build();
    }
}
```

#### ä¿®æ”¹4ï¼šprojectæœåŠ¡ - æ·»åŠ ä¾èµ–

**æ–‡ä»¶**: `project/pom.xml`

```xml
<!-- çº¿ç¨‹æœ¬åœ°å˜é‡ä¼ é€’ -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>transmittable-thread-local</artifactId>
    <version>2.14.2</version>
</dependency>
```

---

## ğŸš€ é‡å¯æœåŠ¡

### âš ï¸ é‡è¦ï¼šå¿…é¡»é‡æ–°ç¼–è¯‘å¹¶é‡å¯æœåŠ¡ï¼

### æ­¥éª¤1ï¼šåœæ­¢ç°æœ‰æœåŠ¡

åœ¨IDEAä¸­åœæ­¢ï¼š
- âŒ åœæ­¢ project æœåŠ¡
- âŒ åœæ­¢ admin æœåŠ¡

æˆ–åœ¨ç»ˆç«¯ä¸­ï¼š
```bash
# æŸ¥æ‰¾Javaè¿›ç¨‹
jps

# åœæ­¢è¿›ç¨‹ï¼ˆæ›¿æ¢ä¸ºå®é™…PIDï¼‰
taskkill /F /PID <project_pid>
taskkill /F /PID <admin_pid>
```

### æ­¥éª¤2ï¼šé‡æ–°ç¼–è¯‘

```bash
# æ–¹å¼1ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•
mvn clean compile

# æ–¹å¼2ï¼šåˆ†åˆ«ç¼–è¯‘
cd project
mvn clean compile

cd ../admin
mvn clean compile
```

### æ­¥éª¤3ï¼šé‡å¯æœåŠ¡

**å¿…é¡»æŒ‰é¡ºåºå¯åŠ¨**ï¼š

#### â‘  å…ˆå¯åŠ¨ project æœåŠ¡
```bash
# æ–¹å¼1ï¼šä½¿ç”¨Maven
cd project
mvn spring-boot:run

# æ–¹å¼2ï¼šä½¿ç”¨IDEA
# è¿è¡Œ ShortLinkApplication.java
```

**ç¡®è®¤å¯åŠ¨æˆåŠŸ**ï¼š
```
çœ‹åˆ°æ—¥å¿—ï¼š
Started ShortLinkApplication in X.XXX seconds
```

è®¿é—®ï¼šhttp://127.0.0.1:8001 ï¼ˆåº”è¯¥å¯ä»¥è®¿é—®ï¼‰

#### â‘¡ å†å¯åŠ¨ admin æœåŠ¡
```bash
# æ–¹å¼1ï¼šä½¿ç”¨Maven
cd admin
mvn spring-boot:run

# æ–¹å¼2ï¼šä½¿ç”¨IDEA
# è¿è¡Œ ShortLinkAdminApplication.java
```

**ç¡®è®¤å¯åŠ¨æˆåŠŸ**ï¼š
```
çœ‹åˆ°æ—¥å¿—ï¼š
Started ShortLinkAdminApplication in X.XXX seconds
```

è®¿é—®ï¼šhttp://127.0.0.1:8902 ï¼ˆåº”è¯¥å¯ä»¥è®¿é—®ï¼‰

---

## ğŸ§ª éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

#### 1. åœ¨Apifoxä¸­é‡æ–°æµ‹è¯•

**è¯·æ±‚é…ç½®**ï¼š
- æ–¹æ³•ï¼š`PUT`
- URLï¼š`http://127.0.0.1:8902/api/short-link/admin/v1/update`
- Headersï¼š
  ```
  Content-Type: application/json
  username: your_username     â† ç¡®ä¿ä¼ é€’ç”¨æˆ·å
  token: your_token           â† ç¡®ä¿ä¼ é€’token
  ```

**Body**ï¼š
```json
{
  "id": 1971909001333448705,
  "originalGid": "m6zLqv",
  "gid": "nw6zLq",
  "fullShortUrl": "http://baidu.com/1evvi1",
  "originUrl": "http://qrrix.ba/qqqzr12",
  "describe": "æµ‹è¯•è·¨ç»„ç§»åŠ¨",
  "validDateType": 0
}
```

**é¢„æœŸæˆåŠŸå“åº”**ï¼š
```json
{
  "code": "0",
  "message": "success",
  "data": null,
  "success": true
}
```

#### 2. æŸ¥çœ‹åå°æ—¥å¿—

**adminæœåŠ¡æ—¥å¿—** (åº”è¯¥çœ‹åˆ°):
```
è¿œç¨‹è°ƒç”¨ä¿®æ”¹çŸ­é“¾æ¥å¼€å§‹ - URL: http://127.0.0.1:8001/api/short-link/v1/update
ä¼ é€’ç”¨æˆ·ä¿¡æ¯ - username: xxxx
è¿œç¨‹è°ƒç”¨ä¿®æ”¹çŸ­é“¾æ¥æˆåŠŸ
```

**projectæœåŠ¡æ—¥å¿—** (åº”è¯¥çœ‹åˆ°):
```
æ¥æ”¶åˆ°ç”¨æˆ·ä¿¡æ¯ - username: xxxx
ä¿®æ”¹çŸ­é“¾æ¥å¼€å§‹ï¼Œid: 1971909001333448705
æŸ¥è¯¢çŸ­é“¾æ¥ï¼ŒoriginalGid: m6zLqv, fullShortUrl: http://baidu.com/1evvi1
æŸ¥è¯¢åˆ°çŸ­é“¾æ¥ï¼Œid: 1971909001333448705, originalGid: m6zLqv, targetGid: nw6zLq
gid å·²å˜åŒ–ï¼Œæ‰§è¡Œåˆ é™¤+æ’å…¥æ“ä½œï¼Œæ—§gid: m6zLqv, æ–°gidï¼šnw6zLq
ä¿®æ”¹çŸ­é“¾æ¥æˆåŠŸï¼Œid: 1971909001333448705
```

#### 3. éªŒè¯æ•°æ®è¿ç§»

**åœ¨æ–°åˆ†ç»„æŸ¥è¯¢**ï¼š
```http
GET http://127.0.0.1:8902/api/short-link/admin/v1/page?gid=nw6zLq&current=1&size=10
```
âœ… åº”è¯¥èƒ½æŸ¥åˆ°è®°å½•

**åœ¨æ—§åˆ†ç»„æŸ¥è¯¢**ï¼š
```http
GET http://127.0.0.1:8902/api/short-link/admin/v1/page?gid=m6zLqv&current=1&size=10
```
âœ… åº”è¯¥æŸ¥ä¸åˆ°è¯¥è®°å½•

---

## ğŸ“‹ é—®é¢˜æ’æŸ¥æ¸…å•

### å¦‚æœè¿˜æ˜¯401é”™è¯¯

#### æ£€æŸ¥1ï¼šç¡®è®¤æœåŠ¡å·²é‡å¯
```bash
# æŸ¥çœ‹Javaè¿›ç¨‹å¯åŠ¨æ—¶é—´
jps -lv

# åº”è¯¥æ˜¯æœ€è¿‘å‡ åˆ†é’Ÿå†…å¯åŠ¨çš„
```

#### æ£€æŸ¥2ï¼šç¡®è®¤SecurityConfigurationç”Ÿæ•ˆ
åœ¨projectæœåŠ¡å¯åŠ¨æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼š
```
Using generated security password: ...
```
å¦‚æœçœ‹åˆ°è¿™ä¸ªæ—¥å¿—ï¼Œè¯´æ˜SecurityConfigurationæ²¡æœ‰ç”Ÿæ•ˆï¼Œéœ€è¦æ£€æŸ¥ï¼š
- æ–‡ä»¶ä½ç½®æ˜¯å¦æ­£ç¡®ï¼š`project/src/main/java/com/nageoffer/shorlink/project/config/SecurityConfiguration.java`
- @Configuration å’Œ @EnableWebSecurity æ³¨è§£æ˜¯å¦æ­£ç¡®

#### æ£€æŸ¥3ï¼šç¡®è®¤UserTransmitFilterç”Ÿæ•ˆ
åœ¨projectæœåŠ¡å¯åŠ¨æ—¥å¿—ä¸­æŸ¥æ‰¾ï¼š
```
Mapping filter: 'globalUserTransmitFilter' to: [/*]
```
å¦‚æœæ²¡æœ‰çœ‹åˆ°ï¼Œè¯´æ˜UserConfigurationæ²¡æœ‰ç”Ÿæ•ˆ

#### æ£€æŸ¥4ï¼šç¡®è®¤usernameä¼ é€’
åœ¨Apifoxçš„Headersä¸­å¿…é¡»åŒ…å«ï¼š
```
username: your_username
token: your_token
```

å¯ä»¥åœ¨adminæœåŠ¡æ—¥å¿—ä¸­ç¡®è®¤ï¼š
```
ä¼ é€’ç”¨æˆ·ä¿¡æ¯ - username: xxxx
```

### å¦‚æœæ˜¯å…¶ä»–é”™è¯¯

#### "çŸ­é“¾æ¥è®°å½•ä¸å­˜åœ¨"
- æ£€æŸ¥originalGidæ˜¯å¦æ­£ç¡®
- æ£€æŸ¥fullShortUrlæ˜¯å¦æ­£ç¡®
- å‚è€ƒä¹‹å‰çš„ã€Šæµ‹è¯•å¤±è´¥åŸå› åˆ†æ.mdã€‹

#### "ç³»ç»Ÿæ‰§è¡Œå‡ºé”™"
- æŸ¥çœ‹projectæœåŠ¡çš„è¯¦ç»†æ—¥å¿—
- æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
- æ£€æŸ¥ShardingSphereé…ç½®

---

## ğŸ¯ å®Œæ•´æµ‹è¯•æµç¨‹

### å‡†å¤‡å·¥ä½œ
1. âœ… åœæ­¢æ‰€æœ‰æœåŠ¡
2. âœ… é‡æ–°ç¼–è¯‘ä»£ç 
3. âœ… å¯åŠ¨projectæœåŠ¡ (8001)
4. âœ… å¯åŠ¨adminæœåŠ¡ (8902)
5. âœ… ç¡®è®¤ä¸¤ä¸ªæœåŠ¡éƒ½å¯åŠ¨æˆåŠŸ

### æµ‹è¯•ä¿®æ”¹æ¥å£
1. âœ… åœ¨Apifoxé…ç½®Headersï¼ˆusername + tokenï¼‰
2. âœ… å¡«å†™æ­£ç¡®çš„è¯·æ±‚å‚æ•°ï¼ˆoriginalGid + gidï¼‰
3. âœ… å‘é€è¯·æ±‚
4. âœ… æ”¶åˆ°æˆåŠŸå“åº” (code = "0")
5. âœ… æŸ¥çœ‹åå°æ—¥å¿—ç¡®è®¤æ‰§è¡Œæµç¨‹
6. âœ… æŸ¥è¯¢éªŒè¯æ•°æ®å·²è¿ç§»

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

### é—®é¢˜æ ¹æº
1. **Spring Securityé»˜è®¤å¯ç”¨**: projectæœåŠ¡å¼•å…¥äº†spring-boot-starter-securityä¾èµ–
2. **ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ä¼ é€’**: adminè°ƒç”¨projectæ—¶æ²¡æœ‰ä¼ é€’è®¤è¯ä¿¡æ¯
3. **ç¼ºå°‘æ¥æ”¶æœºåˆ¶**: projectæ²¡æœ‰æ¥æ”¶å’Œå¤„ç†ç”¨æˆ·ä¿¡æ¯çš„Filter

### è§£å†³æ–¹æ¡ˆ
1. **ä¼ é€’ç”¨æˆ·ä¿¡æ¯**: adminåœ¨RestTemplateè°ƒç”¨æ—¶æ·»åŠ usernameåˆ°Header
2. **æ¥æ”¶ç”¨æˆ·ä¿¡æ¯**: projectæ·»åŠ UserTransmitFilteræå–username
3. **å…³é—­Securityè®¤è¯**: é…ç½®Spring Securityå…è®¸æ‰€æœ‰è¯·æ±‚
4. **æ·»åŠ å¿…è¦ä¾èµ–**: transmittable-thread-localç”¨äºçº¿ç¨‹æœ¬åœ°å˜é‡ä¼ é€’

### æ¶æ„è¯´æ˜
```
å‰ç«¯/Apifox
  â†“ (å¸¦ username + token)
AdminæœåŠ¡ (8902)
  â”œâ”€ UserTransmitFilter: éªŒè¯å¹¶å­˜å‚¨username
  â”œâ”€ Controller: æ¥æ”¶è¯·æ±‚
  â””â”€ ShortLinkRemoteServiceImpl: 
      â”œâ”€ ä»UserContextè·å–username
      â””â”€ é€šè¿‡Headerä¼ é€’usernameç»™project
          â†“ (RestTemplate + Header)
ProjectæœåŠ¡ (8001)
  â”œâ”€ SecurityConfiguration: å…è®¸æ‰€æœ‰è¯·æ±‚
  â”œâ”€ UserTransmitFilter: ä»Headeræå–username
  â”œâ”€ Controller: æ¥æ”¶è¯·æ±‚
  â””â”€ Service: å¤„ç†ä¸šåŠ¡é€»è¾‘
```

---

## âš ï¸ é‡è¦æç¤º

1. **å¿…é¡»é‡å¯æœåŠ¡**: ä»£ç ä¿®æ”¹åï¼Œå¿…é¡»é‡æ–°ç¼–è¯‘å’Œé‡å¯
2. **å¯åŠ¨é¡ºåº**: å…ˆprojectï¼Œåadmin
3. **ä¼ é€’username**: Apifoxæµ‹è¯•æ—¶Headerså¿…é¡»åŒ…å«usernameå’Œtoken
4. **æŸ¥çœ‹æ—¥å¿—**: å‡ºé—®é¢˜æ—¶ç¬¬ä¸€æ—¶é—´æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

---

**ä¿®å¤å®Œæˆï¼æŒ‰ç…§ä¸Šè¿°æ­¥éª¤é‡å¯æœåŠ¡åï¼Œåº”è¯¥å°±èƒ½æˆåŠŸæµ‹è¯•äº† ğŸ‰**




