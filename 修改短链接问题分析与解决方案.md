# ä¿®æ”¹çŸ­é“¾æ¥é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ”´ é—®é¢˜è¯Šæ–­

### æ ¸å¿ƒé—®é¢˜
ä¿®æ”¹çŸ­é“¾æ¥åŠŸèƒ½åœ¨**åˆ†åº“åˆ†è¡¨ï¼ˆShardingSphereï¼‰åœºæ™¯ä¸‹æŸ¥è¯¢ä¸åˆ°æ•°æ®**ã€‚

### é—®é¢˜åŸå› 

1. **åˆ†ç‰‡é”®é…ç½®**ï¼š`gid`ï¼ˆåˆ†ç»„æ ‡è¯†ï¼‰æ˜¯ShardingSphereçš„åˆ†ç‰‡é”®
   ```yaml
   # shardingsphere-config-dev.yaml
   shardingColumn: gid  # ä½¿ç”¨ gid ä½œä¸ºåˆ†ç‰‡é”®
   type: HASH_MOD       # å“ˆå¸Œå–æ¨¡ç®—æ³•
   sharding-count: 16   # 16ä¸ªåˆ†ç‰‡è¡¨
   ```

2. **é”™è¯¯çš„æŸ¥è¯¢é€»è¾‘**ï¼ˆä¿®å¤å‰ï¼‰ï¼š
   ```java
   // âŒ é”™è¯¯ï¼šä½¿ç”¨æ–°çš„gidæŸ¥è¯¢æ—§çš„è®°å½•
   LambdaQueryWrapper<ShortLinkDO> queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)
       .eq(ShortLinkDO::getGid, requestParam.getGid())  // è¿™æ˜¯æ–°çš„gidï¼
       .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())
       .eq(ShortLinkDO::getDelFlag, 0);
   ```

3. **æ•°æ®è·¯ç”±é—®é¢˜**ï¼š
   - å‡è®¾çŸ­é“¾æ¥åŸæœ¬åœ¨åˆ†ç»„Aï¼ˆoriginalGid = "A"ï¼‰
   - ç”¨æˆ·æƒ³ç§»åŠ¨åˆ°åˆ†ç»„Bï¼ˆnewGid = "B"ï¼‰
   - ShardingSphereæ ¹æ®gidè®¡ç®—åˆ†ç‰‡ï¼š
     - åˆ†ç»„A â†’ è·¯ç”±åˆ°åˆ†ç‰‡è¡¨ t_link_5
     - åˆ†ç»„B â†’ è·¯ç”±åˆ°åˆ†ç‰‡è¡¨ t_link_12
   - ä½¿ç”¨æ–°gidæŸ¥è¯¢æ—¶ï¼ŒShardingSphereä¼šè·¯ç”±åˆ° t_link_12
   - ä½†æ•°æ®å®é™…è¿˜åœ¨ t_link_5 ä¸­ â†’ **æŸ¥è¯¢å¤±è´¥ï¼**

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯
åŒºåˆ†**åŸå§‹gid**ï¼ˆç”¨äºå®šä½è®°å½•ï¼‰å’Œ**ç›®æ ‡gid**ï¼ˆç”¨äºæ›´æ–°æ•°æ®ï¼‰ã€‚

### ä¿®æ”¹å†…å®¹

#### 1. DTOå­—æ®µå¢å¼º

**adminç«¯** (`ShortLinkUpdateReqDTO.java`)ï¼š
```java
/**
 * åŸå§‹åˆ†ç»„æ ‡è¯†ï¼ˆç”¨äºå®šä½è®°å½•ï¼‰
 */
private String originalGid;

/**
 * åˆ†ç»„æ ‡è¯†ï¼ˆç›®æ ‡åˆ†ç»„ï¼‰
 */
private String gid;
```

**projectç«¯** (`ShortLinkUpdateReqDTO.java`)ï¼š
```java
// ç›¸åŒçš„å­—æ®µå®šä¹‰
private String originalGid;  // åŸå§‹åˆ†ç»„
private String gid;          // ç›®æ ‡åˆ†ç»„
```

#### 2. Serviceå±‚æŸ¥è¯¢é€»è¾‘ä¿®æ­£

**å…³é”®ä¿®æ”¹ç‚¹**ï¼š
```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨åŸå§‹gidæŸ¥è¯¢
LambdaQueryWrapper<ShortLinkDO> queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)
    .eq(ShortLinkDO::getGid, requestParam.getOriginalGid())  // ä½¿ç”¨åŸå§‹gid
    .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())
    .eq(ShortLinkDO::getDelFlag, 0);
```

**å®Œæ•´çš„æ›´æ–°é€»è¾‘**ï¼š
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void updateShortLink(ShortLinkUpdateReqDTO requestParam) {
    // 1. å‚æ•°æ ¡éªŒ
    if (requestParam.getOriginalGid() == null || requestParam.getOriginalGid().trim().isEmpty()) {
        throw new ServiceException("åŸå§‹åˆ†ç»„æ ‡è¯†ä¸èƒ½ä¸ºç©º");
    }
    
    // 2. ä½¿ç”¨originalGidæŸ¥è¯¢è®°å½•ï¼ˆç¡®ä¿è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†ç‰‡è¡¨ï¼‰
    LambdaQueryWrapper<ShortLinkDO> queryWrapper = Wrappers.lambdaQuery(ShortLinkDO.class)
        .eq(ShortLinkDO::getGid, requestParam.getOriginalGid())
        .eq(ShortLinkDO::getFullShortUrl, requestParam.getFullShortUrl())
        .eq(ShortLinkDO::getDelFlag, 0);
    ShortLinkDO hasShortLinkDO = baseMapper.selectOne(queryWrapper);
    
    // 3. åˆ¤æ–­gidæ˜¯å¦å˜åŒ–
    if (Objects.equals(requestParam.getOriginalGid(), requestParam.getGid())) {
        // æƒ…å†µ1ï¼šgidæœªå˜åŒ–ï¼Œç›´æ¥æ›´æ–°
        LambdaUpdateWrapper<ShortLinkDO> updateWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class)
            .eq(ShortLinkDO::getId, requestParam.getId())
            .eq(ShortLinkDO::getGid, requestParam.getOriginalGid())
            .eq(ShortLinkDO::getDelFlag, 0);
        baseMapper.update(shortLinkDO, updateWrapper);
    } else {
        // æƒ…å†µ2ï¼šgidå·²å˜åŒ–ï¼Œåˆ é™¤æ—§è®°å½• + æ’å…¥æ–°è®°å½•ï¼ˆè·¨åˆ†ç‰‡è¿ç§»ï¼‰
        LambdaUpdateWrapper<ShortLinkDO> deleteWrapper = Wrappers.lambdaUpdate(ShortLinkDO.class)
            .eq(ShortLinkDO::getId, requestParam.getId())
            .eq(ShortLinkDO::getGid, requestParam.getOriginalGid())  // ä½¿ç”¨åŸå§‹gidåˆ é™¤
            .eq(ShortLinkDO::getDelFlag, 0);
        baseMapper.delete(deleteWrapper);
        
        baseMapper.insert(shortLinkDO);  // æ–°è®°å½•ä¼šæ ¹æ®æ–°gidè·¯ç”±åˆ°æ–°åˆ†ç‰‡è¡¨
    }
}
```

## ğŸ“‹ å‰ç«¯æ”¹åŠ¨è¦ç‚¹

### APIè°ƒç”¨å‚æ•°è°ƒæ•´

**ä¿®æ”¹å‰**ï¼š
```javascript
// âŒ åªä¼ é€’æ–°çš„gid
{
  id: 123,
  gid: "new-group-id",        // æ–°åˆ†ç»„
  originUrl: "https://...",
  describe: "..."
}
```

**ä¿®æ”¹å**ï¼š
```javascript
// âœ… åŒæ—¶ä¼ é€’åŸå§‹gidå’Œæ–°gid
{
  id: 123,
  originalGid: "old-group-id",  // åŸå§‹åˆ†ç»„ï¼ˆå…³é”®ï¼ï¼‰
  gid: "new-group-id",          // ç›®æ ‡åˆ†ç»„
  originUrl: "https://...",
  describe: "..."
}
```

### å‰ç«¯å®ç°å»ºè®®

```javascript
// åœ¨ç¼–è¾‘å¯¹è¯æ¡†æ‰“å¼€æ—¶ï¼Œä¿å­˜åŸå§‹gid
const [originalGid, setOriginalGid] = useState('');

function openEditDialog(shortLink) {
  setOriginalGid(shortLink.gid);  // ä¿å­˜åŸå§‹gid
  // ... å…¶ä»–é€»è¾‘
}

// æäº¤æ—¶åŒæ—¶ä¼ é€’originalGidå’Œgid
function handleSubmit(formData) {
  const payload = {
    id: formData.id,
    originalGid: originalGid,     // åŸå§‹åˆ†ç»„
    gid: formData.gid,            // ç”¨æˆ·é€‰æ‹©çš„æ–°åˆ†ç»„
    originUrl: formData.originUrl,
    describe: formData.describe,
    // ... å…¶ä»–å­—æ®µ
  };
  
  api.updateShortLink(payload);
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1ï¼šgidä¸å˜ï¼ˆåŒç»„å†…ä¿®æ”¹ï¼‰
```
åŸå§‹ï¼šgid = "group-1", originUrl = "https://old.com"
ä¿®æ”¹ï¼šgid = "group-1", originUrl = "https://new.com"

é¢„æœŸï¼šç›´æ¥åœ¨ t_link_X è¡¨ä¸­æ›´æ–°è®°å½•
```

#### åœºæ™¯2ï¼šgidæ”¹å˜ï¼ˆè·¨ç»„ç§»åŠ¨ï¼‰
```
åŸå§‹ï¼šgid = "group-1", originUrl = "https://example.com"
ä¿®æ”¹ï¼šgid = "group-2", originUrl = "https://example.com"

é¢„æœŸï¼š
1. ä» t_link_5 åˆ é™¤è®°å½•ï¼ˆå‡è®¾group-1è·¯ç”±åˆ°åˆ†ç‰‡5ï¼‰
2. å‘ t_link_12 æ’å…¥è®°å½•ï¼ˆå‡è®¾group-2è·¯ç”±åˆ°åˆ†ç‰‡12ï¼‰
```

### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæµ‹è¯•æ•°æ®**ï¼š
   ```sql
   -- åˆ›å»ºä¸€ä¸ªçŸ­é“¾æ¥
   INSERT INTO t_link (gid, full_short_url, origin_url, ...) 
   VALUES ('test-group-1', 'http://short.com/abc', 'https://example.com', ...);
   ```

2. **æµ‹è¯•åŒç»„ä¿®æ”¹**ï¼š
   ```bash
   PUT /api/short-link/admin/v1/update
   {
     "id": 1,
     "originalGid": "test-group-1",
     "gid": "test-group-1",
     "originUrl": "https://new-example.com"
   }
   ```

3. **æµ‹è¯•è·¨ç»„ç§»åŠ¨**ï¼š
   ```bash
   PUT /api/short-link/admin/v1/update
   {
     "id": 1,
     "originalGid": "test-group-1",
     "gid": "test-group-2",
     "originUrl": "https://new-example.com"
   }
   ```

4. **éªŒè¯æ•°æ®åº“**ï¼š
   ```sql
   -- æŸ¥çœ‹åŸåˆ†ç‰‡è¡¨ï¼ˆåº”è¯¥å·²åˆ é™¤æˆ–æ ‡è®°åˆ é™¤ï¼‰
   SELECT * FROM t_link_X WHERE full_short_url = 'http://short.com/abc';
   
   -- æŸ¥çœ‹æ–°åˆ†ç‰‡è¡¨ï¼ˆåº”è¯¥æœ‰æ–°è®°å½•ï¼‰
   SELECT * FROM t_link_Y WHERE full_short_url = 'http://short.com/abc';
   ```

## ğŸ“š çŸ¥è¯†æ‰©å±•

### ShardingSphereåˆ†ç‰‡è·¯ç”±åŸç†

```
æŸ¥è¯¢SQL: SELECT * FROM t_link WHERE gid = 'group-1' AND ...

ShardingSphereè·¯ç”±è¿‡ç¨‹ï¼š
1. è¯†åˆ«åˆ†ç‰‡é”®ï¼šgid = 'group-1'
2. è®¡ç®—å“ˆå¸Œå€¼ï¼šhash('group-1') = 12345
3. å–æ¨¡è¿ç®—ï¼š12345 % 16 = 5
4. è·¯ç”±åˆ°åˆ†ç‰‡ï¼št_link_5
5. æ‰§è¡ŒçœŸå®SQLï¼šSELECT * FROM t_link_5 WHERE gid = 'group-1' AND ...
```

### ä¸ºä»€ä¹ˆå¿…é¡»ç”¨originalGidï¼Ÿ

| åœºæ™¯ | ä½¿ç”¨å­—æ®µ | ShardingSphereè·¯ç”± | ç»“æœ |
|------|---------|-------------------|------|
| æŸ¥è¯¢æ—§è®°å½• | newGid | è·¯ç”±åˆ°æ–°åˆ†ç‰‡è¡¨ | âŒ æŸ¥ä¸åˆ°ï¼ˆæ•°æ®åœ¨æ—§åˆ†ç‰‡ï¼‰ |
| æŸ¥è¯¢æ—§è®°å½• | originalGid | è·¯ç”±åˆ°æ—§åˆ†ç‰‡è¡¨ | âœ… æŸ¥åˆ°æ•°æ® |
| æ›´æ–°åˆ°æ–°åˆ†ç»„ | newGid | æ’å…¥æ–°åˆ†ç‰‡è¡¨ | âœ… æ­£ç¡® |

### è·¨åˆ†ç‰‡æ›´æ–°çš„ç­–ç•¥

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| ç›´æ¥UPDATE | ç®€å• | âŒ æ— æ³•è·¨åˆ†ç‰‡ | gidä¸å˜ |
| DELETE + INSERT | âœ… æ”¯æŒè·¨åˆ†ç‰‡ | äº‹åŠ¡å¤æ‚ | gidæ”¹å˜ |
| è½¯åˆ é™¤ + INSERT | ä¿ç•™å†å² | æ•°æ®å†—ä½™ | éœ€è¦å®¡è®¡ |

æœ¬é¡¹ç›®é‡‡ç”¨ **DELETE + INSERT** æ–¹æ¡ˆï¼Œåœ¨äº‹åŠ¡ä¸­ä¿è¯åŸå­æ€§ã€‚

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‰ç«¯å¿…é¡»ä¼ é€’originalGid**ï¼šè¿™æ˜¯å®šä½è®°å½•çš„å…³é”®ï¼
2. **originalGidä¸èƒ½ä¸ºç©º**ï¼šå·²æ·»åŠ å‚æ•°æ ¡éªŒ
3. **äº‹åŠ¡ä¿è¯**ï¼šè·¨åˆ†ç‰‡çš„åˆ é™¤+æ’å…¥æ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **å…¨é“¾è·¯æ—¥å¿—**ï¼šå»ºè®®åœ¨è°ƒè¯•é˜¶æ®µæ‰“å¼€SQLæ—¥å¿—æŸ¥çœ‹å®é™…æ‰§è¡Œçš„åˆ†ç‰‡è·¯ç”±

## ğŸ“ æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**åˆ†åº“åˆ†è¡¨åœºæ™¯ä¸‹çš„è·¨åˆ†ç‰‡æ›´æ–°é—®é¢˜**ã€‚æ ¸å¿ƒè¦ç‚¹ï¼š

1. âœ… ä½¿ç”¨ `originalGid` å®šä½æ—§è®°å½•ï¼ˆç¡®ä¿è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†ç‰‡è¡¨ï¼‰
2. âœ… ä½¿ç”¨ `gid` æŒ‡å®šç›®æ ‡åˆ†ç»„ï¼ˆå†³å®šæ–°è®°å½•çš„åˆ†ç‰‡ä½ç½®ï¼‰
3. âœ… è·¨åˆ†ç‰‡æ›´æ–°é‡‡ç”¨"åˆ é™¤æ—§è®°å½• + æ’å…¥æ–°è®°å½•"ç­–ç•¥
4. âœ… å‰ç«¯éœ€è¦åŒæ—¶ä¼ é€’ `originalGid` å’Œ `gid`

---

**ä¿®æ”¹å®Œæˆåï¼Œè¯·é‡æ–°ç¼–è¯‘é¡¹ç›®å¹¶æµ‹è¯•åŠŸèƒ½ï¼**




